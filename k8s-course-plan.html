<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-12-23 Mon 09:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>K8s course</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Byron Wang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">K8s course</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6ea3c94">1. 课程目的</a>
<ul>
<li><a href="#orgaaf6536">1.1. 进阶要求</a></li>
</ul>
</li>
<li><a href="#org3c18456">2. 课程安排</a></li>
<li><a href="#orgdb63d1e">3. 了解 kubernetes 之前<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-06 Fri&gt;</span></span></a>
<ul>
<li><a href="#orge911d01">3.1. 课程大纲</a></li>
<li><a href="#org3daff4c">3.2. Cgroup、Container 与 OCI</a>
<ul>
<li><a href="#org9b340e4">3.2.1. cgroups &amp; namespaces &amp; chroot &amp; systemd</a></li>
<li><a href="#org1b9f07d">3.2.2. Container 的前世今生</a></li>
<li><a href="#org6e0847e">3.2.3. OCI</a></li>
<li><a href="#org4a83150">3.2.4. docker 中容器的创建</a></li>
</ul>
</li>
<li><a href="#org754eada">3.3. Docker 与虚拟机</a>
<ul>
<li><a href="#orgd7fe522">3.3.1. 主流虚拟机的原理</a></li>
<li><a href="#orgc1992a4">3.3.2. 容器与虚拟机</a></li>
</ul>
</li>
<li><a href="#orgdf6c45e">3.4. kubernetes 是什么</a>
<ul>
<li><a href="#org4dc24ec">3.4.1. 我们为什么需要编排</a></li>
<li><a href="#org15e560c">3.4.2. kubernetes 的历史</a></li>
</ul>
</li>
<li><a href="#orge1a6e9e">3.5. kubernetes 生态与社区</a>
<ul>
<li><a href="#org5006753">3.5.1. kubernetes 生态中的明星</a></li>
<li><a href="#orgf495fad">3.5.2. kubernetes 社区</a></li>
</ul>
</li>
<li><a href="#orgc0d6835">3.6. 课后作业</a></li>
</ul>
</li>
<li><a href="#org92db551">4. Containers 与 Pods<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-13 Fri&gt;</span></span></a>
<ul>
<li><a href="#orge6a8fc0">4.1. 课程大纲</a></li>
<li><a href="#orga83d214">4.2. CRI</a>
<ul>
<li><a href="#org2544a35">4.2.1. CRI 的意义</a></li>
<li><a href="#orgccdda32">4.2.2. CRI 的接口</a></li>
</ul>
</li>
<li><a href="#orgd6b7d3c">4.3. 容器与 Pod</a>
<ul>
<li><a href="#orgd1a1b52">4.3.1. Pod 是什么</a></li>
<li><a href="#orgcd0f60a">4.3.2. Pod 里面有什么</a></li>
<li><a href="#orga7adfc8">4.3.3. Pod 实现原理</a></li>
<li><a href="#orgdf1155f">4.3.4. init containers</a></li>
<li><a href="#orgfbe4d90">4.3.5. POD 的生命周期</a></li>
<li><a href="#orge034f4f">4.3.6. Pod 的回收</a></li>
<li><a href="#orga2525b6">4.3.7. multi Pod 的实际场景</a></li>
</ul>
</li>
<li><a href="#orgfc6f8da">4.4. 课后作业</a></li>
</ul>
</li>
<li><a href="#orga223910">5. Yaml 与 kubectl <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-20 Fri&gt;</span></span></a>
<ul>
<li><a href="#org3125aa7">5.1. 课程大纲</a></li>
<li><a href="#orgdbab12b">5.2. kubernetes yaml</a>
<ul>
<li><a href="#org8f14503">5.2.1. annotation</a></li>
<li><a href="#org871ed82">5.2.2. label &amp;&amp; selector</a></li>
<li><a href="#org55789bb">5.2.3. namespace</a></li>
<li><a href="#org77a1ea3">5.2.4. apiVersion</a></li>
<li><a href="#org1be1ff4">5.2.5. toleration &amp;&amp; taint</a></li>
</ul>
</li>
<li><a href="#org9c53d1a">5.3. kubectl</a>
<ul>
<li><a href="#orgd8e3b47">5.3.1. kubectl get</a></li>
<li><a href="#orged3a31d">5.3.2. kubectl apply</a></li>
<li><a href="#orgee07d68">5.3.3. kubectl logs</a></li>
<li><a href="#org40a335d">5.3.4. kubectl exec</a></li>
<li><a href="#orgffdbb64">5.3.5. kubectl edit</a></li>
</ul>
</li>
<li><a href="#orgd270f5f">5.4. 作业</a></li>
</ul>
</li>
<li><a href="#org8da7d54">6. 部署你的第一个 kubernetes 集群</a>
<ul>
<li>
<ul>
<li><a href="#orge25272b">6.0.1. 课程大纲</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org37138be">7. Pod controllers</a></li>
<li><a href="#orgfb3a6e6">8. Service Loadbalanceing and Networking</a></li>
<li><a href="#orgf6bc0f0">9. Storage</a></li>
<li><a href="#orged8b6c0">10. Security</a></li>
<li><a href="#org81b7823">11. 初识 kubernetes 组件</a>
<ul>
<li>
<ul>
<li><a href="#org8d41ba0">11.0.1. 课程大纲</a></li>
<li><a href="#org1cf9cda">11.0.2. kubernetes 的组件</a></li>
<li><a href="#orge0a3527">11.0.3. Links</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org6ea3c94" class="outline-2">
<h2 id="org6ea3c94"><span class="section-number-2">1</span> 课程目的</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>可以独立安装 k8s 集群</li>
<li>可以简单运维 k8s 集群</li>
<li>了解 k8s 组件与代码结构</li>
<li>对云计算及生态有初步认识</li>
<li>具备通过 ckad 的能力</li>
</ul>
</div>
<div id="outline-container-orgaaf6536" class="outline-3">
<h3 id="orgaaf6536"><span class="section-number-3">1.1</span> 进阶要求</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>可以实现一个 CNI/CRD/CCM</li>
<li>成为 k8s contributor</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3c18456" class="outline-2">
<h2 id="org3c18456"><span class="section-number-2">2</span> 课程安排</h2>
<div class="outline-text-2" id="text-2">
<p>
地点:会议室
时间:每周五下午 16:00-17:00
时间安排: 45min(讲解) + 15min(答疑)
作业形式: 问卷与实际操作
</p>
</div>
</div>
<div id="outline-container-orgdb63d1e" class="outline-2">
<h2 id="orgdb63d1e"><span class="section-number-2">3</span> 了解 kubernetes 之前<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-06 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orge911d01" class="outline-3">
<h3 id="orge911d01"><span class="section-number-3">3.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>操作系统基础</li>
<li>简介 docker 与 container</li>
<li>docker 与虚拟机的区别</li>
<li>认识什么是 kubernetes</li>
</ul>
</div>
</div>
<div id="outline-container-org3daff4c" class="outline-3">
<h3 id="org3daff4c"><span class="section-number-3">3.2</span> Cgroup、Container 与 OCI</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org9b340e4" class="outline-4">
<h4 id="org9b340e4"><span class="section-number-4">3.2.1</span> cgroups &amp; namespaces &amp; chroot &amp; systemd</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
cgroups<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup> 用来控制一个每个服务的 CPU、mem、block I/O、device、net(tc)
</p>

<p>
namespaces<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> 用来做进程之间的隔离;UTS:主机 域名 IPC: 信号量 消息队列 共享内存 PID Network:设备 端口 网络栈 Mount: fs User:group user
</p>

<p>
chroot<sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup> 用于将一个进程及其子进程的根目录改变到文件系统中的一个新位置，让这些进程只能访问到该目录。这个功能的想法是为每个进程提供独立的磁盘空间
</p>

<p>
systemd<sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup> 用来启动守护进程,处理依赖关系
</p>
</div>
</div>
<div id="outline-container-org1b9f07d" class="outline-4">
<h4 id="org1b9f07d"><span class="section-number-4">3.2.2</span> Container 的前世今生</h4>
<div class="outline-text-4" id="text-3-2-2">
<ul class="org-ul">
<li>1979 — chroot 一切的开始</li>
<li>2000 — FreeBSD Jails 支持进程沙盒</li>
<li>2001 — Linux VServer  加入 security context</li>
<li>2004 — Solaris Containers 支持在 x86 和 SPARC 系统</li>
<li>2005 — OpenVZ      IPC 与设备的隔离</li>
<li>2006 — Process Containers kernel 2.6.24</li>
<li>2008 — LXC 第一个最完善的 Linux 容器管理器的实现方案;现在容器技术的雏形</li>
<li>2011 — Warde CloudFoundry 支持多个操作系统</li>
<li>2013 — LMCTFY Let Me Contain That For You  Google libcontainer 的前身</li>
<li>2013 — Docker images swarm 集大成者</li>
<li>2014 — Rocket CoreOS</li>
<li>2016 — Windows Containers Hyper-v</li>
<li>2017 — Pouch 富容器 Alibaba</li>
<li>2018 — Podman without of daemon</li>
<li>2018 — WIndows Containers Windows-base</li>
</ul>
</div>
</div>
<div id="outline-container-org6e0847e" class="outline-4">
<h4 id="org6e0847e"><span class="section-number-4">3.2.3</span> OCI</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
open container initiative<sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup>
</p>

<p>
Linux 基金会制定一个开放的工业化标准：容器运行时标准 （runtime spec）和 容器镜像标准（image spec）
</p>
<ul class="org-ul">
<li>image spec
文件系统
manifest 文件
index 文件</li>
<li>runtime spec
Container ID
PID
容器文件目录
容器创建
容器进程启动
容器暂停
容器暂停信号捕获
容器的生命周期: init creating created running stopped</li>
</ul>
</div>
</div>
<div id="outline-container-org4a83150" class="outline-4">
<h4 id="org4a83150"><span class="section-number-4">3.2.4</span> docker 中容器的创建</h4>
<div class="outline-text-4" id="text-3-2-4">

<div class="figure">
<p><img src="images/docker-runc.png" alt="docker-runc.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org754eada" class="outline-3">
<h3 id="org754eada"><span class="section-number-3">3.3</span> Docker 与虚拟机</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-orgd7fe522" class="outline-4">
<h4 id="orgd7fe522"><span class="section-number-4">3.3.1</span> 主流虚拟机的原理</h4>
<div class="outline-text-4" id="text-3-3-1">
</div>
<ol class="org-ol">
<li><a id="org4a60a71"></a>虚拟化技术<br />
<div class="outline-text-6" id="text-3-3-1-0-1">
<ul class="org-ul">
<li><p>
I型虚拟机
直接跑在裸机上，虚拟机软件模拟了完整的底层硬件;从 Cpu、时钟到外接设备
</p>

<p>
代表技术 VMwareESX  Hyper-V
</p></li>
<li><p>
II型虚拟机
运行在宿主机的操作系统之上,所有的操作都借助于宿主机的操作系统
</p>

<p>
代表技术: VMWare Workstation Hyper-V
</p></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgc1992a4" class="outline-4">
<h4 id="orgc1992a4"><span class="section-number-4">3.3.2</span> 容器与虚拟机</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
容器本身是虚拟化技术中的一种,作为最轻量级的虚拟化方案出现
</p>

<p>
但容器与虚拟机有本质上的区别
</p>

<p>
容器实际上是一个进程，而虚拟机则是一个完整的操作系统
</p>
</div>
</div>
</div>
<div id="outline-container-orgdf6c45e" class="outline-3">
<h3 id="orgdf6c45e"><span class="section-number-3">3.4</span> kubernetes 是什么</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Production-Grade Container Scheduling and Management
这是 kubernetes github 仓库上对这个项目的描述
</p>
</div>
<div id="outline-container-org4dc24ec" class="outline-4">
<h4 id="org4dc24ec"><span class="section-number-4">3.4.1</span> 我们为什么需要编排</h4>
<div class="outline-text-4" id="text-3-4-1">
<p>
我们不妨了解一下小明的故事
</p>
</div>
<ol class="org-ol">
<li><a id="org4396282"></a>小明是一个开发者<br />
<div class="outline-text-6" id="text-3-4-1-0-1">
<p>
小明是一个开发者，这一天他想到了一个点子，他做了一个静态的网站，现在他想把网站上线。
于是他将代码拷贝到了租赁的服务器上运行，因为他有三个服务器，他不想每次都把改动传递很多次.
</p>

<p>
于是他想到了 Docker,他写了一个 Dockerfile 将网站打包成了 Docker 镜像，传到了镜像仓库，
他每次只要到三个服务器上更新容器的镜像就好了
</p>
</div>
</li>
<li><a id="org8826704"></a>小明的网站提供其他的服务了<br />
<div class="outline-text-6" id="text-3-4-1-0-2">
<p>
小明的网站提供其他的服务了，小明的网站现在不仅仅是一个静态页面了，现在小明需要爬取一些数据，然后展示出来，
于是小明现在有两个服务：一个展示网站，一个用来爬取数据的服务。
小明遇到了问题:展示网站怎么连接到爬取数据的服务上，
</p>

<p>
于是小明将容器暴露了相应的端口用于内部服务的访问
</p>
</div>
</li>
<li><a id="org8275305"></a>小明的业务又扩展了<br />
<div class="outline-text-6" id="text-3-4-1-0-3">
<p>
小明的业务又扩展了，小明现在需要将爬取所有的数据存下来，放便做统计与查询。
</p>

<p>
小明将本地的目录挂载到了容器目录中，于是所有的数据就都保存在了本地。
</p>
</div>
</li>
<li><a id="org69cc43b"></a>小明的业务发展的特别迅速<br />
<div class="outline-text-6" id="text-3-4-1-0-4">
<p>
小明的业务发展的特别迅速，他有了几十倍的用户了，原有的三台服务器无法承受过大的压力，于是小明又多租了 17 台服务器，
这时小明遇到了几个问题：每一台机器存储的数据无法同步，而且现在每做一次改动都要改动到 20 台服务器上，小明觉得太麻烦了
</p>

<p>
于是小明将几台机器做成了 NFS 的服务器，然后所有的容器都挂载 NFS 的目录进行存储，又使用了一些批量处理工具。小明对自己很满意。
</p>
</div>
</li>
<li><a id="orged7622c"></a>小明的服务间歇性的被冲跨了<br />
<div class="outline-text-6" id="text-3-4-1-0-5">
<p>
小明的服务间歇性的被冲跨了，小明突然发现自己的服务在每天晚上凌晨左右会有几台被巨大的请求冲垮，小明现在无力负担起更多的服务器了，
小明只能运营商处购买负载均衡服务，试图将流量均匀的分配到不同的机器上。这样过了几天，小明发现有许多用户抱怨内容出现丢失了，
小明经过排查发现，由于 DNS 的原因之前的每个用户一般都被会到特定的几台机器上，由于 NFS 挂载的不是相同的目录，造成目录之间数据
不一致。现在用户的请求统一经过运营商的负载均衡，导致用户的内容丢失。在加上运营商机器并不是很稳定，导致服务器经常失连。
小明已经陷入了深深的运维漩涡当中，小明不想再维护了。
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org15e560c" class="outline-4">
<h4 id="org15e560c"><span class="section-number-4">3.4.2</span> kubernetes 的历史</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
kubernetes 由 Google 内部的编排系统 Borg 演化出来
</p>

<p>
2014 年 6 月揭牌
</p>

<p>
2015年7月22日K8S迭代到 v 1.0并正式对外公布
</p>

<p>
如今已经正式版本已到 1.16.3
</p>
</div>
</div>
</div>
<div id="outline-container-orge1a6e9e" class="outline-3">
<h3 id="orge1a6e9e"><span class="section-number-3">3.5</span> kubernetes 生态与社区</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-org5006753" class="outline-4">
<h4 id="org5006753"><span class="section-number-4">3.5.1</span> kubernetes 生态中的明星</h4>
<div class="outline-text-4" id="text-3-5-1">
</div>
<ol class="org-ol">
<li><a id="org2f12a65"></a>网络<br />
<div class="outline-text-6" id="text-3-5-1-0-1">
<ul class="org-ul">
<li>flannel</li>
<li>calico</li>
<li>Core-DNS</li>
</ul>
</div>
</li>
<li><a id="org0d16764"></a>存储<br />
<div class="outline-text-6" id="text-3-5-1-0-2">
<ul class="org-ul">
<li>etcd</li>
</ul>
</div>
</li>
<li><a id="org6ea7dd6"></a>其他<br />
<div class="outline-text-6" id="text-3-5-1-0-3">
<ul class="org-ul">
<li>helm</li>
<li>prometheus</li>
<li>istio</li>
<li>knative</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf495fad" class="outline-4">
<h4 id="orgf495fad"><span class="section-number-4">3.5.2</span> kubernetes 社区</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
<a href="https://github.com/kubernetes/kubernetes">https://github.com/kubernetes/kubernetes</a>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Project</th>
<th scope="col" class="org-right">contributors</th>
<th scope="col" class="org-right">commit</th>
<th scope="col" class="org-right">issue</th>
<th scope="col" class="org-right">PR</th>
<th scope="col" class="org-right">members</th>
<th scope="col" class="org-right">release</th>
<th scope="col" class="org-left">star</th>
<th scope="col" class="org-left">fork</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Docker</td>
<td class="org-right">1845</td>
<td class="org-right">38049</td>
<td class="org-right">3673</td>
<td class="org-right">197</td>
<td class="org-right">20</td>
<td class="org-right">198</td>
<td class="org-left">55.8k</td>
<td class="org-left">16.1k</td>
</tr>

<tr>
<td class="org-left">Kubernetes</td>
<td class="org-right">2378</td>
<td class="org-right">86276</td>
<td class="org-right">2244</td>
<td class="org-right">1079</td>
<td class="org-right">529</td>
<td class="org-right">586</td>
<td class="org-left">60.8k</td>
<td class="org-left">21.5k</td>
</tr>

<tr>
<td class="org-left">Tidb</td>
<td class="org-right">372</td>
<td class="org-right">9834</td>
<td class="org-right">1086</td>
<td class="org-right">136</td>
<td class="org-right">63</td>
<td class="org-right">81</td>
<td class="org-left">21.7k</td>
<td class="org-left">3.3k</td>
</tr>
</tbody>
</table>


<div class="figure">
<p><img src="images/k8s-ans.png" alt="k8s-ans.png" />
</p>
</div>


<div class="figure">
<p><img src="images/docker-ans.png" alt="docker-ans.png" />
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc0d6835" class="outline-3">
<h3 id="orgc0d6835"><span class="section-number-3">3.6</span> 课后作业</h3>
<div class="outline-text-3" id="text-3-6">
<p>
1.安装 docker,并运行一个 nginx
</p>

<p>
2.给一个容器设置 &#x2013;cpus  &#x2013;cpuset-cpus 并观察 cpu 的使用
</p>

<p>
3.一个四核的机器上设置 &#x2013;cpus=2.5 &#x2013;cpuset-cpus="0,1" 那么容器最多可以占用多少 cpu 资源?为什么？
</p>

<p>
请将 1 、3 两个问题的答案发送至邮箱,截至日期为下次课程开始之前
</p>
</div>
</div>
</div>
<div id="outline-container-org92db551" class="outline-2">
<h2 id="org92db551"><span class="section-number-2">4</span> Containers 与 Pods<span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-13 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orge6a8fc0" class="outline-3">
<h3 id="orge6a8fc0"><span class="section-number-3">4.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 CRI 以及 CRI 的意义，从而了解 k8s 的方向</li>
<li class="off"><code>[&#xa0;]</code> 明白 pods 与 containers 的区别与关系</li>
<li class="off"><code>[&#xa0;]</code> 了解 pods 的原理</li>
<li class="off"><code>[&#xa0;]</code> 初识 k8s yaml</li>
</ul>
</div>
</div>
<div id="outline-container-orga83d214" class="outline-3">
<h3 id="orga83d214"><span class="section-number-3">4.2</span> CRI</h3>
<div class="outline-text-3" id="text-4-2">

<div class="figure">
<p><img src="./images/松溪观鹿图.jpeg" alt="松溪观鹿图.jpeg" />
</p>
</div>
</div>
<div id="outline-container-org2544a35" class="outline-4">
<h4 id="org2544a35"><span class="section-number-4">4.2.1</span> CRI 的意义</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
kubernetes 将其可以剥离开的部分转换为接口对外开放出去
</p>

<p>
1.减少核心的代码可以保证代码稳定性与产品质量
</p>

<p>
2.k8s 不依赖于某几种场景，这种方式带给 k8s 更多的可能
</p>

<p>
CRI 就是其开放出去的一个，CRI (container runtime interface)
</p>

<p>
CRI 的出现是对 Docker 的一个巨大打击 CRI 出现在 kubernetes 1.5 的版本中 2016 年 12 月，而正是此时，docker 公司正在进行他的商业化的第一步
</p>

<p>
Docker 的最大优势在于庞大的用户与及其优秀的生态,许多人都是从 Docker 才了解了容器，包括现在仍然有许多人提起容器仅能想起 Docker
</p>

<p>
kubernetes 一定不会将自己与 Docker 捆绑在同一条船上，CRI 出现之前尚可称为同床异梦,而在这之后则是真正的分居
</p>

<p>
kubernetes 在此刻已经展现了自己的爪牙
</p>
</div>
</div>
<div id="outline-container-orgccdda32" class="outline-4">
<h4 id="orgccdda32"><span class="section-number-4">4.2.2</span> CRI 的接口</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
CRI Proto<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>
</p>
<div class="org-src-container">
<pre class="src src-go">service <span style="color: #7aa6da;">RuntimeService</span> <span style="color: #eaeaea;">{</span>
    rpc <span style="color: #7aa6da;">Version</span><span style="color: #70c0b1;">(</span>VersionRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>VersionResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">RunPodSandbox</span><span style="color: #70c0b1;">(</span>RunPodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>RunPodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">StopPodSandbox</span><span style="color: #70c0b1;">(</span>StopPodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StopPodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">RemovePodSandbox</span><span style="color: #70c0b1;">(</span>RemovePodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>RemovePodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">PodSandboxStatus</span><span style="color: #70c0b1;">(</span>PodSandboxStatusRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>PodSandboxStatusResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ListPodSandbox</span><span style="color: #70c0b1;">(</span>ListPodSandboxRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ListPodSandboxResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">CreateContainer</span><span style="color: #70c0b1;">(</span>CreateContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>CreateContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">StartContainer</span><span style="color: #70c0b1;">(</span>StartContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StartContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">StopContainer</span><span style="color: #70c0b1;">(</span>StopContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StopContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">RemoveContainer</span><span style="color: #70c0b1;">(</span>RemoveContainerRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>RemoveContainerResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ListContainers</span><span style="color: #70c0b1;">(</span>ListContainersRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ListContainersResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ContainerStatus</span><span style="color: #70c0b1;">(</span>ContainerStatusRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ContainerStatusResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">ExecSync</span><span style="color: #70c0b1;">(</span>ExecSyncRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ExecSyncResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">Exec</span><span style="color: #70c0b1;">(</span>ExecRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>ExecResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">Attach</span><span style="color: #70c0b1;">(</span>AttachRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>AttachResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">PortForward</span><span style="color: #70c0b1;">(</span>PortForwardRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>PortForwardResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">UpdateRuntimeConfig</span><span style="color: #70c0b1;">(</span>UpdateRuntimeConfigRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>UpdateRuntimeConfigResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
    rpc <span style="color: #7aa6da;">Status</span><span style="color: #70c0b1;">(</span>StatusRequest<span style="color: #70c0b1;">)</span> <span style="color: #7aa6da;">returns</span> <span style="color: #70c0b1;">(</span>StatusResponse<span style="color: #70c0b1;">)</span> <span style="color: #70c0b1;">{}</span>
<span style="color: #eaeaea;">}</span>
</pre>
</div>
<p>
这里有了个新的概念 PodSandbox
就是我们下面要说到的 Pod
</p>
</div>
</div>
</div>
<div id="outline-container-orgd6b7d3c" class="outline-3">
<h3 id="orgd6b7d3c"><span class="section-number-3">4.3</span> 容器与 Pod</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgd1a1b52" class="outline-4">
<h4 id="orgd1a1b52"><span class="section-number-4">4.3.1</span> Pod 是什么</h4>
<div class="outline-text-4" id="text-4-3-1">

<div class="figure">
<p><img src="./images/pods.jpg" alt="pods.jpg" />
</p>
</div>

<p>
Pod 是 kubernetes 中部署与调度的最小单元
</p>

<p>
听起来是不是似曾相识
</p>
</div>
</div>
<div id="outline-container-orgcd0f60a" class="outline-4">
<h4 id="orgcd0f60a"><span class="section-number-4">4.3.2</span> Pod 里面有什么</h4>
<div class="outline-text-4" id="text-4-3-2">

<div class="figure">
<p><img src="./images/pods.png" alt="pods.png" />
</p>
</div>

<p>
Pod 内的容器共享网络与存储
</p>

<p>
这意味着在同一个 Pod 中的容器有着相同的 IP 与端口
</p>
</div>
</div>
<div id="outline-container-orga7adfc8" class="outline-4">
<h4 id="orga7adfc8"><span class="section-number-4">4.3.3</span> Pod 实现原理</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
pause-container 是实现 Pod 共享 namespace 的基础
</p>

<p>
在 linux 中，当你启动一个进程的时候，子进程自动继承父进程的 namespace
</p>

<p>
当你使用 unshare 的方式时会创建一个新的 namespace
</p>

<p>
pause-container 就是做这个事情的，当启动一个 Pod 时，kubernetes 创建了一个 pause 容器
</p>

<p>
并单独的创建了一个 net namespace，然后将其余的容器加入到了这个 pause 容器创建的 namespace 中
</p>

<p>
Pod 中可以配置一个参数 shareProcessNamespace 控制是否可以共享 PID
</p>

<p>
当你的 Pod 没有启用该参数时，在 container 中可以发现 pid 1 是 container commands
</p>

<p>
当启用时， pid 1 是 pause
</p>

<p>
shareProcessNamespace 会用在一些特定的场景
</p>

<p>
1.有一些镜像在 PID 不是 1 无法启动例如 systemd
</p>

<p>
2./proc 下面文件共享
</p>

<p>
3.文件系统共享 /proc/$pid/root
</p>
</div>
</div>

<div id="outline-container-orgdf1155f" class="outline-4">
<h4 id="orgdf1155f"><span class="section-number-4">4.3.4</span> init containers</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
在 Pod 中,你无法控制两个 container 的启动顺序，但是所有的 container 在启动之前都会先启动 init containers
</p>

<p>
init containers 可以有多个，init containers 是有顺序的
</p>

<p>
init containers 使用的是 linux namespace secrets
</p>

<p>
init containers 场景
</p>

<p>
1.加载一些工具
</p>

<p>
2.可以作为应用的部署器
</p>
</div>
</div>
<div id="outline-container-orgfbe4d90" class="outline-4">
<h4 id="orgfbe4d90"><span class="section-number-4">4.3.5</span> POD 的生命周期</h4>
<div class="outline-text-4" id="text-4-3-5">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">value</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Pending</td>
<td class="org-left">The Pod has been accepted by the Kubernetes system, but one or more of the Container images has not been created. This includes time before being scheduled as well as time spent downloading images over the network, which could take a while.</td>
</tr>

<tr>
<td class="org-left">Running</td>
<td class="org-left">The Pod has been bound to a node, and all of the Containers have been created. At least one Container is still running, or is in the process of starting or restarting</td>
</tr>

<tr>
<td class="org-left">Succeeded</td>
<td class="org-left">All Containers in the Pod have terminated in success, and will not be restarted.</td>
</tr>

<tr>
<td class="org-left">Failed</td>
<td class="org-left">All Containers in the Pod have terminated, and at least one Container has terminated in failure. That is, the Container either exited with non-zero status or was terminated by the system.</td>
</tr>

<tr>
<td class="org-left">Unknown</td>
<td class="org-left">For some reason the state of the Pod could not be obtained, typically due to an error in communicating with the host of the Pod</td>
</tr>
</tbody>
</table>

<div class="figure">
<p><img src="./images/pod-phase.png" alt="pod-phase.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orge034f4f" class="outline-4">
<h4 id="orge034f4f"><span class="section-number-4">4.3.6</span> Pod 的回收</h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
Pod 的回收在 kubernetes 中面临这样几个问题:
</p>

<p>
1.清理 Pod 这个资源
</p>

<p>
2.清理 Pod 关联的其他资源
</p>

<p>
3.清理 Pod 中的容器
</p>

<p>
简单的来看是这样的一个流程,但这其中还涉及 kubelet 的垃圾回收机制, 会在之后的章节中详细说明
</p>

<p>
客户端请求删除 Pod &#x2013;&gt;
</p>

<p>
apiserver 更新 Pod 信息 &#x2013;&gt;
</p>

<p>
kubelet 优雅释放 Pod 资源 &#x2013;&gt;
</p>

<p>
kubelet 请求删除 Pod &#x2013;&gt;
</p>

<p>
apiserver 删除 etcd 中 Pod 信息&#x2013;&gt;
</p>

<p>
kubelet完成最终Pod的资源清理
</p>
</div>
</div>
<div id="outline-container-orga2525b6" class="outline-4">
<h4 id="orga2525b6"><span class="section-number-4">4.3.7</span> multi Pod 的实际场景</h4>
<div class="outline-text-4" id="text-4-3-7">
<p>
     <img src="./images/sidecar.jpeg" alt="sidecar.jpeg" />
sidecar 到 service mesh
</p>

<p>
如果说 kubernetes 管理你的基础设施 service mesh 则管理应用的全部
</p>

<p>
比如说 服务发现 融断 负载均衡 灰度发布甚至安全
<img src="./images/service-mesh-nginx.png" alt="service-mesh-nginx.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgfc6f8da" class="outline-3">
<h3 id="orgfc6f8da"><span class="section-number-3">4.4</span> 课后作业</h3>
<div class="outline-text-3" id="text-4-4">
<p>
1.简单论述 OCI 与 CRI 的区别
</p>

<p>
2.使用提供的工具模拟一个 Pod
tools:
</p>
<ul class="org-ul">
<li>unshare</li>
<li>docker run</li>
</ul>
<p>
images:
</p>
<ul class="org-ul">
<li>nginx</li>
<li>daocloud.io/daocloud/dao-2048</li>
<li>gcr.azk8s.cn/google_containers/pause:3.1</li>
</ul>
<p>
config:
</p>
<div class="org-src-container">
<pre class="src src-nginx"><span style="color: #b9ca4a;">cat</span> &lt;&lt;EOF &gt;&gt; nginx.conf
<span style="color: #b9ca4a;">error_log</span> stderr;
<span style="color: #b9ca4a;">events</span> <span style="color: #eaeaea;">{</span> worker_connections  1024; <span style="color: #eaeaea;">}</span>
<span style="color: #b9ca4a;">http</span> <span style="color: #eaeaea;">{</span>
    <span style="color: #b9ca4a;">access_log</span> /dev/stdout combined;
    <span style="color: #b9ca4a;">server</span> <span style="color: #70c0b1;">{</span>
        <span style="color: #b9ca4a;">listen</span> 8080 default_server;
        <span style="color: #b9ca4a;">server_name</span> example.com www.example.com;
        <span style="color: #b9ca4a;">location</span> <span style="color: #e78c45;">/</span> <span style="color: #e7c547;">{</span>
            <span style="color: #b9ca4a;">proxy_pass</span> http://127.0.0.1:80;
        <span style="color: #e7c547;">}</span>
    <span style="color: #70c0b1;">}</span>
<span style="color: #eaeaea;">}</span>
<span style="color: #b9ca4a;">EOF</span>
</pre>
</div>
<p>
1.nginx 不暴露端口
</p>

<p>
2.pause 暴露端口 30001:8080
</p>

<p>
3.2048 不暴露端口
</p>

<p>
4.当访问本地的 30001 端口时可以出现 2048 游戏界面
</p>
</div>
</div>
</div>
<div id="outline-container-orga223910" class="outline-2">
<h2 id="orga223910"><span class="section-number-2">5</span> Yaml 与 kubectl <span class="timestamp-wrapper"><span class="timestamp">&lt;2019-12-20 Fri&gt;</span></span></h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org3125aa7" class="outline-3">
<h3 id="org3125aa7"><span class="section-number-3">5.1</span> 课程大纲</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 kubernetes yaml 的格式</li>
<li class="off"><code>[&#xa0;]</code> kubectl 常用的命令</li>
<li class="off"><code>[&#xa0;]</code> kubectl 的使用g</li>
</ul>
</div>
</div>
<div id="outline-container-orgdbab12b" class="outline-3">
<h3 id="orgdbab12b"><span class="section-number-3">5.2</span> kubernetes yaml</h3>
<div class="outline-text-3" id="text-5-2">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Pod
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">annotations</span>:
    <span style="color: #e7c547;">cni.projectcalico.org/podIP</span>: 192.168.159.56/32
  <span style="color: #e7c547;">labels</span>:
    <span style="color: #e7c547;">app</span>: nginx
  <span style="color: #e7c547;">name</span>: nginx-pod-test1
  <span style="color: #e7c547;">namespace</span>: default
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">containers</span>:
  - <span style="color: #e7c547;">image</span>: nginx:1.7.9
    <span style="color: #e7c547;">imagePullPolicy</span>: Always
    <span style="color: #e7c547;">name</span>: nginx
    <span style="color: #e7c547;">ports</span>:
    - <span style="color: #e7c547;">containerPort</span>: 80
      <span style="color: #e7c547;">protocol</span>: TCP
    <span style="color: #e7c547;">resources</span>:
      <span style="color: #e7c547;">requests</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"30Mi"</span>
      <span style="color: #e7c547;">limits</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"200Mi"</span>
  <span style="color: #e7c547;">restartPolicy</span>: Always
  <span style="color: #e7c547;">schedulerName</span>: default-scheduler
  <span style="color: #e7c547;">terminationGracePeriodSeconds</span>: 30
  <span style="color: #e7c547;">tolerations</span>:
  - <span style="color: #e7c547;">effect</span>: NoExecute
    <span style="color: #e7c547;">key</span>: node.kubernetes.io/not-ready
    <span style="color: #e7c547;">operator</span>: Exists
    <span style="color: #e7c547;">tolerationSeconds</span>: 300
  - <span style="color: #e7c547;">effect</span>: NoExecute
    <span style="color: #e7c547;">key</span>: node.kubernetes.io/unreachable
    <span style="color: #e7c547;">operator</span>: Exists
    <span style="color: #e7c547;">tolerationSeconds</span>: 300
</pre>
</div>
</div>
<div id="outline-container-org8f14503" class="outline-4">
<h4 id="org8f14503"><span class="section-number-4">5.2.1</span> annotation</h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
注释以 kv 的方式存储
</p>

<p>
有最大长度限制
</p>
</div>
</div>
<div id="outline-container-org871ed82" class="outline-4">
<h4 id="org871ed82"><span class="section-number-4">5.2.2</span> label &amp;&amp; selector</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
用来调度与标明身份
</p>

<p>
是 kubernetes 判断身份的基础
</p>
</div>
</div>
<div id="outline-container-org55789bb" class="outline-4">
<h4 id="org55789bb"><span class="section-number-4">5.2.3</span> namespace</h4>
<div class="outline-text-4" id="text-5-2-3">
<pre class="example">
kubectl get ns
</pre>
<p>
1.default
</p>

<p>
2.kube-system kubernetes 系统的
</p>

<p>
3.kube-public 用来对集群所有用户可读的
</p>
</div>
</div>
<div id="outline-container-org77a1ea3" class="outline-4">
<h4 id="org77a1ea3"><span class="section-number-4">5.2.4</span> apiVersion</h4>
<div class="outline-text-4" id="text-5-2-4">
<p>
kubernetes 采用了标准的 REST API, 外部的用户命令与组件之间的通信，经过 apiserver 的部分都会使用 RESTAPI
</p>
</div>

<ol class="org-ol">
<li><a id="orgc1e3535"></a>RESTful API<br />
<div class="outline-text-5" id="text-5-2-4-1">
<ul class="org-ul">
<li>一切皆是资源</li>
<li>url 中指定了版本</li>
<li>头部表示 schema</li>
<li>使用 HTTP 的 Method 的与返回码</li>
</ul>
</div>
</li>

<li><a id="orgcb606ec"></a>API 版本信息<br />
<div class="outline-text-5" id="text-5-2-4-2">
<p>
1.alpha 所有包含 alpha 的; feature 可能被修改或删除，可能有 bug，默认禁用
</p>

<p>
2.beta 所有包含 beta 的; 经过测试,默认启用,可能会修改细节但是不会删除
</p>

<p>
3.stable 的版本 v(x)
</p>
</div>
</li>

<li><a id="orgc634d33"></a>API 组<br />
<div class="outline-text-5" id="text-5-2-4-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">/api/v1</td>
<td class="org-left">/api/v1</td>
<td class="org-left">apiVersion: v1</td>
</tr>

<tr>
<td class="org-left">apis/$GROUP_NAME/$VERSION</td>
<td class="org-left">$GROUP_NAME/$VERSION</td>
<td class="org-left">apiVersion: batch/v1</td>
</tr>
</tbody>
</table>
</div>
</li>
</ol>
</div>

<div id="outline-container-org1be1ff4" class="outline-4">
<h4 id="org1be1ff4"><span class="section-number-4">5.2.5</span> toleration &amp;&amp; taint</h4>
<div class="outline-text-4" id="text-5-2-5">
<pre class="example">
kubectl taint nodes node1 key=value:NoSchedule
</pre>
<p>
给节点 node1 打了一个污点 key value effact
所有的 pod 都不会被调度到这台机器上，除非存在相应的容忍
</p>
</div>
</div>
</div>

<div id="outline-container-org9c53d1a" class="outline-3">
<h3 id="org9c53d1a"><span class="section-number-3">5.3</span> kubectl</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-orgd8e3b47" class="outline-4">
<h4 id="orgd8e3b47"><span class="section-number-4">5.3.1</span> kubectl get</h4>
<div class="outline-text-4" id="text-5-3-1">
<div class="org-src-container">
<pre class="src src-shell">kubectl get po $<span style="color: #e7c547;">podname</span> -o wide
</pre>
</div>
</div>
</div>
<div id="outline-container-orged3a31d" class="outline-4">
<h4 id="orged3a31d"><span class="section-number-4">5.3.2</span> kubectl apply</h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
kubectl apply -f <b><b><b>*</b></b></b>.yaml
</p>
</div>
</div>
<div id="outline-container-orgee07d68" class="outline-4">
<h4 id="orgee07d68"><span class="section-number-4">5.3.3</span> kubectl logs</h4>
<div class="outline-text-4" id="text-5-3-3">
<div class="org-src-container">
<pre class="src src-shell">kubectl logs -f $<span style="color: #e7c547;">podname</span> <span style="color: #eaeaea;">[</span>-c<span style="color: #eaeaea;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org40a335d" class="outline-4">
<h4 id="org40a335d"><span class="section-number-4">5.3.4</span> kubectl exec</h4>
<div class="outline-text-4" id="text-5-3-4">
<div class="org-src-container">
<pre class="src src-shell">kubectl exec -it <span style="color: #eaeaea;">[</span>-p<span style="color: #eaeaea;">]</span> $<span style="color: #e7c547;">podname</span> <span style="color: #eaeaea;">[</span>-c<span style="color: #eaeaea;">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgffdbb64" class="outline-4">
<h4 id="orgffdbb64"><span class="section-number-4">5.3.5</span> kubectl edit</h4>
<div class="outline-text-4" id="text-5-3-5">
<div class="org-src-container">
<pre class="src src-shell">kubectl edit $<span style="color: #e7c547;">resource</span> $<span style="color: #e7c547;">name</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd270f5f" class="outline-3">
<h3 id="orgd270f5f"><span class="section-number-3">5.4</span> 作业</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #e7c547;">apiVersion</span>: v1
<span style="color: #e7c547;">kind</span>: Pod
<span style="color: #e7c547;">metadata</span>:
  <span style="color: #e7c547;">name</span>: memory-demo-2
  <span style="color: #e7c547;">namespace</span>: mem-example
<span style="color: #e7c547;">spec</span>:
  <span style="color: #e7c547;">containers</span>:
  - <span style="color: #e7c547;">name</span>: memory-demo-2-ctr
    <span style="color: #e7c547;">image</span>: polinux/stress
    <span style="color: #e7c547;">resources</span>:
      <span style="color: #e7c547;">requests</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"50Mi"</span>
      <span style="color: #e7c547;">limits</span>:
        <span style="color: #e7c547;">memory</span>: <span style="color: #70c0b1;">"100Mi"</span>
    <span style="color: #e7c547;">command</span>: [<span style="color: #70c0b1;">"stress"</span>]
    <span style="color: #e7c547;">args</span>: [<span style="color: #70c0b1;">"--vm"</span>, <span style="color: #70c0b1;">"1"</span>, <span style="color: #70c0b1;">"--vm-bytes"</span>, <span style="color: #70c0b1;">"250M"</span>, <span style="color: #70c0b1;">"--vm-hang"</span>, <span style="color: #70c0b1;">"1"</span>]
</pre>
</div>
<p>
1.描述启动该 yaml 时出现了什么情况(报错与 pod 状态)，并解释为什么
</p>

<p>
2.修改这个 yaml 使得该 pod 可以运行
</p>

<p>
<a href="https://www.katacoda.com/courses/kubernetes/playground">https://www.katacoda.com/courses/kubernetes/playground</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org8da7d54" class="outline-2">
<h2 id="org8da7d54"><span class="section-number-2">6</span> 部署你的第一个 kubernetes 集群</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orge25272b" class="outline-4">
<h4 id="orge25272b"><span class="section-number-4">6.0.1</span> 课程大纲</h4>
<div class="outline-text-4" id="text-6-0-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 部署一个两节点的 kubernetes 集群</li>
<li class="off"><code>[&#xa0;]</code> 在 kubernetes 集群上部署一个经典的微服务程序</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org37138be" class="outline-2">
<h2 id="org37138be"><span class="section-number-2">7</span> Pod controllers</h2>
</div>
<div id="outline-container-orgfb3a6e6" class="outline-2">
<h2 id="orgfb3a6e6"><span class="section-number-2">8</span> Service Loadbalanceing and Networking</h2>
</div>
<div id="outline-container-orgf6bc0f0" class="outline-2">
<h2 id="orgf6bc0f0"><span class="section-number-2">9</span> Storage</h2>
</div>
<div id="outline-container-orged8b6c0" class="outline-2">
<h2 id="orged8b6c0"><span class="section-number-2">10</span> Security</h2>
</div>
<div id="outline-container-org81b7823" class="outline-2">
<h2 id="org81b7823"><span class="section-number-2">11</span> 初识 kubernetes 组件</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-org8d41ba0" class="outline-4">
<h4 id="org8d41ba0"><span class="section-number-4">11.0.1</span> 课程大纲</h4>
<div class="outline-text-4" id="text-11-0-1">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> 了解 kubernetes 有哪些组件</li>
<li class="off"><code>[&#xa0;]</code> 简介 kubernetes 内的对象与资源</li>
</ul>
</div>
</div>
<div id="outline-container-org1cf9cda" class="outline-4">
<h4 id="org1cf9cda"><span class="section-number-4">11.0.2</span> kubernetes 的组件</h4>
<div class="outline-text-4" id="text-11-0-2">
</div>
<ol class="org-ol">
<li><a id="org6039650"></a>kubelet<br /></li>
<li><a id="org8e8e9af"></a>api-server<br /></li>
<li><a id="org525cf04"></a>kube-controller<br /></li>
<li><a id="org6a5dc3c"></a>scheduler<br /></li>
<li><a id="orgae7a5b4"></a>kube-proxy<br /></li>
<li><a id="orgb9e2d56"></a>etcd<br /></li>
<li><a id="orge8101f7"></a>core-dns<br /></li>
</ol>
</div>
<div id="outline-container-orge0a3527" class="outline-4">
<h4 id="orge0a3527"><span class="section-number-4">11.0.3</span> Links</h4>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man7/cgroups.7.html">http://man7.org/linux/man-pages/man7/cgroups.7.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man7/namespaces.7.html">http://man7.org/linux/man-pages/man7/namespaces.7.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man2/chroot.2.html">http://man7.org/linux/man-pages/man2/chroot.2.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
<a href="http://man7.org/linux/man-pages/man1/init.1.html">http://man7.org/linux/man-pages/man1/init.1.html</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
<a href="https://github.com/opencontainers">https://github.com/opencontainers</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
<a href="https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/pkg/kubelet/api/v1alpha1/runtime/api.proto">https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/pkg/kubelet/api/v1alpha1/runtime/api.proto</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Byron Wang</p>
<p class="date">Created: 2019-12-23 Mon 09:34</p>
<p class="validation"></p>
</div>
</body>
</html>
